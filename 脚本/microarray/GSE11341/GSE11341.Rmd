GSE11341
========================================================

##按照丰核要求做报告##

载入数据
```{r echo=FALSE}
setwd("~/Projects/microarray_data/GSE11341/CELs")
library(affy)
gse <- ReadAffy()
gse_sample <- read.csv("../Samples.csv")
sampleNames(gse) <- sub("\\.CEL$","",sampleNames(gse))
mt <- match(gse_sample$SampleID,sampleNames(gse))
vmd <- data.frame(labelDescription=c("Sample ID","Tissue type","Oxygen status","Repeat times"))
phenoData(gse) <- new("AnnotatedDataFrame",data=gse_sample[mt,],varMetadata=vmd)
sampleNames(gse) <- sampleNames(gse@protocolData)

colf1 <- gl(1,11,labels="lightblue")
colf2 <- gl(1,12,labels="pink")
colf <- factor(c(levels(colf1)[colf1],levels(colf2)[colf2]))
group_color <- as.character(colf)
#或者
#colf <- factor(c(rep("lightblue",11),rep("pink",12)))
#group_color <- as.character(colf)

#如果要调整cel文件顺序，使用类似命令即可
#sampleNames(gse)
##"GSM286407" "GSM286408" ...
#gse <- gse[,c("GSM286408","GSM286407", ...)]

library(annotate)
gse_annotation <- annPkgName(gse@annotation,type="db")
#biocLite(gse_annotation)
library(gse_annotation,character.only=T)
```

质量检验

```{r echo=FALSE}
library(simpleaffy)
gse_qc <- qc(gse)
plot(gse_qc)

library(affyPLM)
gse_PLM <- fitPLM(gse)
par(mar=c(6,3,2,2))
boxplot(gse_PLM,main="NUSE",col=group_color,las=3,ylim=c(0.95,1.1),whisklty=0)
Mbox(gse_PLM,main="RLE",col=group_color,las=3,ylim=c(-0.4,0.4),whisklty=0)

gse_deg <- AffyRNAdeg(gse)
par(mar=c(5,3,3,0))
colRNAdeg <- rainbow(23)
plotAffyRNAdeg(gse_deg,col=colRNAdeg)
legend("topleft",rownames(pData(gse)),col=colRNAdeg,lwd=1,ncol=4,inset=0.05,cex=0.5)
```

均一化

```{r echo=FALSE}
gse_rma <- rma(gse)
par(mar=c(6,3,2,2))
boxplot(gse_rma,col=group_color,las=3,main="RMA")
```

选取差异表达基因

```{r echo=FALSE}
library(limma)
gse_eset <- exprs(gse_rma)
levels <- factor(paste(gse_sample$Tissue,gse_sample$Oxygen,sep="."))
design <- model.matrix(~0+levels)
colnames(design) <- levels(levels)
corfit <- duplicateCorrelation(gse_eset,design,block=gse_sample$Repeat)
fit <- lmFit(gse_eset,design,block=gse_sample$Repeat,correlation=corfit$consensus.correlation)
cm <- makeContrasts(
  Cardiac3=Cardiac.cells_3hrHypoxia-Cardiac.cells_Normoxia,
  Cardiac24=Cardiac.cells_24hrHypoxia-Cardiac.cells_Normoxia,
  Cardiac48=Cardiac.cells_48hrHypoxia-Cardiac.cells_Normoxia,
  Lung3=Lung.cells_3hrHypoxia-Lung.cells_Normoxia,
  Lung24=Lung.cells_24hrHypoxia-Lung.cells_Normoxia,
  Lung48=Lung.cells_48hrHypoxia-Lung.cells_Normoxia,
  levels=design)
fit2 <- contrasts.fit(fit,cm)
fit2 <- eBayes(fit2)
dif <- topTable(fit2,coef=c("Cardiac3","Cardiac24","Cardiac48","Lung3","Lung24","Lung48"))

dif$symbols <- getSYMBOL(rownames(dif),gse_annotation)
dif$EntrezID <- getEG(rownames(dif),gse_annotation)
```

热图

```{r echo=FALSE,}
library(pheatmap)
selected <- gse_eset[rownames(dif),]
rownames(selected) <- dif$symbols
pheatmap(selected,color=colorRampPalette(c("green","black","red"))(100),border_color=NA)
```

统计分析及可视化

```{r echo=FALSE}
library(GOstats)
entrezUniverse <- unique(unlist(mget(rownames(gse_eset),hgu133aENTREZID)))
entrezSelected <- unique(dif[!is.na(dif$EntrezID),"EntrezID"])
params <- new("GOHyperGParams",geneIds=entrezSelected,universeGeneIds=entrezUniverse,annotation=gse_annotation,ontology="BP",pvalueCutoff=0.001,conditional=F,testDirection="over")
hgOver <- hyperGTest(params)
bp <- summary(hgOver)
htmlReport(hgOver,file="../ALL_go.html")
library(Rgraphviz)
ghandle <- goDag(hgOver)
subGHandle <- subGraph(snodes=as.character(summary(hgOver)[,1]),graph=ghandle)
plot(subGHandle)

library(GeneAnswers)
humanGeneInput <- dif[,c("EntrezID","F","adj.P.Val")]
humanExpr <- gse_eset[match(rownames(dif),rownames(gse_eset)),]
humanExpr <- cbind(humanGeneInput[,"EntrezID"],humanExpr)
humanGeneInput <- humanGeneInput[!is.na(humanGeneInput[,1]),]
humanExpr <- humanExpr[!is.na(humanExpr[,1]),]
y <- geneAnswersBuilder(humanGeneInput,"org.Hs.eg.db",categoryType="KEGG",testType="hyperG",pvalueT=0.1,geneExpressionProfile=humanExpr,verbose=F)
yy <- geneAnswersReadable(y,verbose=F)
geneAnswersConceptNet(yy,colorValueColumn="F",centroidSize="pvalue",output="interactive")
yyy <- geneAnswersSort(yy,sortBy="pvalue")
geneAnswersHeatmap(yyy)
```